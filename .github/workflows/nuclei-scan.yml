name: Nuclei Scan

on:
  push:
  pull_request:

jobs:
  nuclei-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Start DVWA containers
      run: docker compose -f compose.yml up -d

    - name: Wait for DVWA to be ready
      run: |
        echo "Waiting for DVWA..."
        for i in {1..40}; do
          STATUS=$(docker inspect --format='{{.State.Health.Status}}' dvwa-dvwa-1 2>/dev/null || echo "starting")
          echo "Status: $STATUS"
          if [ "$STATUS" = "healthy" ]; then
            echo "DVWA is ready!"
            break
          fi
          sleep 5
        done

    - name: Install Nuclei
      run: |
        LATEST=$(curl -sSL https://api.github.com/repos/projectdiscovery/nuclei/releases/latest | grep tag_name | cut -d '"' -f4)
        echo "Latest version: $LATEST"

        curl -LO https://github.com/projectdiscovery/nuclei/releases/download/${LATEST}/nuclei_${LATEST#v}_linux_amd64.zip

        unzip -o nuclei_*_linux_amd64.zip   # <-- FIX: force overwrite, no prompts
        sudo mv nuclei /usr/local/bin/nuclei
        nuclei -version

    - name: Run Nuclei scan
      run: |
        mkdir -p nuclei-output
        nuclei -u http://127.0.0.1:4280 -o nuclei-output/results.txt

    - name: Upload Nuclei Results
      uses: actions/upload-artifact@v4
      with:
        name: nuclei-results
        path: nuclei-output/results.txt
