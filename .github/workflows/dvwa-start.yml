name: DVWA Startup Test

on:
  push:
  workflow_dispatch:

jobs:
  start-dvwa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start DVWA using docker-compose
        run: |
          docker compose -f docker-compose.yml up -d
          echo "Waiting for DVWA to become healthy..."

          # Wait up to ~60 seconds
          for i in {1..20}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' dvwa 2>/dev/null || echo "starting")
            echo "DVWA status: $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "DVWA is ready!"
              exit 0
            fi
            sleep 3
          done

          echo "DVWA did not become ready in time."
          docker logs dvwa
          exit 1

      - name: Print DVWA container logs
        if: failure()
        run: docker logs dvwa
