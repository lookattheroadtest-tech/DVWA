name: DVWA-Startup-Test

on:
  workflow_dispatch:   # <-- THIS is required

jobs:
  start-dvwa:
    runs-on: ubuntu-latest

    services:
      dvwa:
        image: ghcr.io/digininja/dvwa
        ports:
          - 4280:80
        env:
          DB_SERVER: db
        options: >-
          --health-cmd "curl -s http://localhost | grep -q 'DVWA' || exit 1"
          --health-interval 5s
          --health-timeout 2s
          --health-retries 20

      db:
        image: mariadb:10
        env:
          MYSQL_ROOT_PASSWORD: dvwa
          MYSQL_DATABASE: dvwa
          MYSQL_USER: dvwa
          MYSQL_PASSWORD: p@ssw0rd

    steps:
      - name: Wait for DVWA health check
        run: |
          echo "Waiting for DVWA..."
          for i in {1..40}; do
            if curl -s http://localhost:4280 | grep -q "DVWA"; then
              echo "DVWA is up!"
              exit 0
            fi
            echo "Still waiting..."
            sleep 3
          done
          echo "DVWA never started" && exit 1
