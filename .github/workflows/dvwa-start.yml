name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      db:
        image: mariadb:10
        env:
          MYSQL_ROOT_PASSWORD: dvwa
          MYSQL_DATABASE: dvwa
          MYSQL_USER: dvwa
          MYSQL_PASSWORD: p@ssw0rd
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -udvwa -pp@ssw0rd"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      dvwa:
        image: vulnerables/web-dvwa
        ports:
          - 80:80
        # ðŸ‘‡ THIS FIXES YOUR PROBLEM  
        options: --health-cmd="exit 0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for database to be ready
        run: |
          echo "Waiting for DB..."
          for i in {1..30}; do
            if docker exec "$(docker ps -qf name=db)" mysqladmin ping -h 127.0.0.1 -udvwa -pp@ssw0rd --silent; then
              echo "DB is ready!"
              break
            fi
            echo "Waiting..."
            sleep 2
          done

      - name: Run simple test
        run: |
          echo "Containers are running."
          docker ps
